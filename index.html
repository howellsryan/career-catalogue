---
layout: default
---

<h1>My Career Catalogue</h1>

<div id="search-section">
  <div id="search-container">
    <div class="sort-controls">
      <select id="sort-order">
        <option value="date-desc">Newest First</option>
        <option value="date-asc">Oldest First</option>
        <option value="name-asc">Name (A-Z)</option>
      </select>
    </div>
    <form id="search_form" autocomplete="off">
      <input id="search_input" placeholder="Type to search resources...">
    </form>
    <ul id="list"></ul>
    <div id="no-results" class="no-results" style="display: none;">
      <p>No resources found matching your search criteria.</p>
    </div>
    <div id="loading" class="loading">
      <p>Loading files...</p>
    </div>
  </div>
</div>

<script>
  const filterFiles = (filter) => {
    filter = filter.toLowerCase()
    return (file) => {
      const filePath = file.path;
      const fileName = filePath.replace('.md', '').toLowerCase().replace(/-/g, '');
      const isMarkdown = (/.md$/).test(filePath);
      const isNotIndex = filePath !== 'index.html';
      const isInFilter = filter.split(' ')
        .every((token) => fileName.indexOf(token.toLowerCase()) !== -1)
      return isMarkdown && isNotIndex && isInFilter;
    }
  }

  const matchScore = (file, filter) => {
    const fileWords = file.name.replace('.md', '').toLowerCase().split('-');
    filter = filter.toLowerCase()
    let wordIndex;
    let letterPosition;
    for (wordIndex = 0; wordIndex < fileWords.length; wordIndex++) {
      letterPosition = fileWords[wordIndex].indexOf(filter)
      if (letterPosition > -1) break;
    }
    if (letterPosition < 0) {
      letterPosition = 100;
    }
    return wordIndex + letterPosition * 100;
  }
  
  const sortFiles = (files, sortOption, filter = '') => {
    switch (sortOption) {
      case 'date-desc':
        return files.sort((a, b) => new Date(b.commitDate) - new Date(a.commitDate));
      case 'date-asc':
        return files.sort((a, b) => new Date(a.commitDate) - new Date(b.commitDate));
      case 'name-asc':
        return files.sort((a, b) => a.path.localeCompare(b.path));
      default:
        // When sorting by relevance (search results)
        filter = filter.toLowerCase();
        return files.sort((a, b) => matchScore(a, filter) < matchScore(b, filter) ? -1 : 1);
    }
  }

  const formatDate = (dateString) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  }

  const updateList = (files, filter = '') => {
    const filteredFiles = files.filter(filterFiles(filter));
    const sortOption = document.getElementById('sort-order').value;
    const sortedFiles = sortFiles(filteredFiles, sortOption, filter);
    
    const noResultsElement = document.getElementById('no-results');
    
    let htmlString = '';
    if (sortedFiles.length > 0) {
      for (let file of sortedFiles) {
        const fileName = file.path.replace('.md', '');
        const fileDisplayName = file.path.replace('.md', '').split('_').join(' ');
        const dateDisplay = file.commitDate ? `<span class="file-date" style="color: #666; margin-left: 10px; font-size: 0.85em;">${formatDate(file.commitDate)}</span>` : '';
        htmlString += `<li><a href="${fileName}">${fileDisplayName}</a>${dateDisplay}</li>`;
      }
      document.getElementById('list').innerHTML = htmlString;
      noResultsElement.style.display = 'none';
    } else {
      document.getElementById('list').innerHTML = '';
      noResultsElement.style.display = 'block';
    }
  }

  const navigateToFile = (files, filter = '') => {
    const filteredFiles = files.filter(filterFiles(filter));
    if (filteredFiles.length === 1) {
      window.location.href = filteredFiles[0].path;
    }
  }

  async function getFileCommitDate(repoOwner, repoName, filePath) {
    try {
      const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/commits?path=${filePath}&page=1&per_page=1`);
      const commits = await response.json();
      if (commits.length > 0) {
        return commits[0].commit.author.date;
      }
      return null;
    } catch (error) {
      console.error(`Error fetching commit data for ${filePath}:`, error);
      return null;
    }
  }

  async function enrichFilesWithDates(files, repoOwner, repoName) {
    const enrichedFiles = [];
    
    for (const file of files) {
      if (file.type === 'file' && file.path.endsWith('.md')) {
        const commitDate = await getFileCommitDate(repoOwner, repoName, file.path);
        enrichedFiles.push({
          ...file,
          commitDate: commitDate
        });
      }
    }
    
    return enrichedFiles;
  }

  (async () => {
    const repoOwner = 'howellsryan';
    const repoName = 'career-catalogue';
    const loadingElement = document.getElementById('loading');
    
    try {
      loadingElement.style.display = 'block';
      const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/`);
      const data = await response.json();
      
      // Enrich files with commit dates
      const filesWithDates = await enrichFilesWithDates(data, repoOwner, repoName);
      loadingElement.style.display = 'none';
      
      const search_form = document.getElementById('search_form');
      const search_input = document.getElementById('search_input');
      const sort_select = document.getElementById('sort-order');
      const search_value = decodeURIComponent(document.location.search.replace('?', '').replace(/\+/g, ' '));
      search_input.value = search_value;

      updateList(filesWithDates, search_input.value);
      
      // Configure search box events
      search_form.addEventListener('submit', (event) => {
        event.preventDefault();
        navigateToFile(filesWithDates, search_input.value);
      });
      
      search_input.addEventListener('input', (event) => {
        updateList(filesWithDates, event.target.value);
      });
      
      sort_select.addEventListener('change', () => {
        updateList(filesWithDates, search_input.value);
      });
      
      document.addEventListener('keypress', (event) => {
        if (event.target.tagName !== 'INPUT') {
          search_input.focus();
        }
      });
    } catch (error) {
      console.error('Error loading data:', error);
      loadingElement.style.display = 'none';
      document.getElementById('list').innerHTML = '<li><p style="color:red;">Error loading resources. Please try again later.</p></li>';
    }
  })();
</script>